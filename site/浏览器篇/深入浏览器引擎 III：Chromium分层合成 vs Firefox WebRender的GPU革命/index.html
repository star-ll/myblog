
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://www.yujin123.cn/%E6%B5%8F%E8%A7%88%E5%99%A8%E7%AF%87/%E6%B7%B1%E5%85%A5%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%95%E6%93%8E%20III%EF%BC%9AChromium%E5%88%86%E5%B1%82%E5%90%88%E6%88%90%20vs%20Firefox%20WebRender%E7%9A%84GPU%E9%9D%A9%E5%91%BD/">
      
      
        <link rel="prev" href="../%E6%B7%B1%E5%85%A5%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%95%E6%93%8E%20II%EF%BC%9AHTML%20%E8%A7%A3%E6%9E%90%E5%85%A8%E6%B5%81%E7%A8%8B%E2%80%94%E2%80%94%E4%BB%8E%E5%AD%97%E8%8A%82%E6%B5%81%E5%88%B0%20DOM%20%E6%9E%84%E5%BB%BA/">
      
      
        <link rel="next" href="../%E6%B7%B1%E5%85%A5%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%95%E6%93%8E%20IV%EF%BC%9AV8%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>深入浏览器引擎 III：Chromium分层合成 vs Firefox WebRender的GPU革命 - 余烬的个人博客</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#iiichromium-vs-firefox-webrendergpu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="余烬的个人博客" class="md-header__button md-logo" aria-label="余烬的个人博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            余烬的个人博客
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              深入浏览器引擎 III：Chromium分层合成 vs Firefox WebRender的GPU革命
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="余烬的个人博客" class="md-nav__button md-logo" aria-label="余烬的个人博客" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    余烬的个人博客
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    浏览器篇
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            浏览器篇
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%B7%B1%E5%85%A5%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%95%E6%93%8E%20I%EF%BC%9A%E4%BB%8E%E5%A4%9A%E8%BF%9B%E7%A8%8B%E6%9E%B6%E6%9E%84%E5%88%B0%E6%B8%B2%E6%9F%93%E5%BC%95%E6%93%8E/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    深入浏览器引擎 I：从多进程架构到渲染引擎
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%B7%B1%E5%85%A5%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%95%E6%93%8E%20II%EF%BC%9AHTML%20%E8%A7%A3%E6%9E%90%E5%85%A8%E6%B5%81%E7%A8%8B%E2%80%94%E2%80%94%E4%BB%8E%E5%AD%97%E8%8A%82%E6%B5%81%E5%88%B0%20DOM%20%E6%9E%84%E5%BB%BA/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    深入浏览器引擎 II：HTML 解析全流程——从字节流到 DOM 构建
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    深入浏览器引擎 III：Chromium分层合成 vs Firefox WebRender的GPU革命
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    深入浏览器引擎 III：Chromium分层合成 vs Firefox WebRender的GPU革命
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      渲染管线
    </span>
  </a>
  
    <nav class="md-nav" aria-label="渲染管线">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      解析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      样式计算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      布局
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chromium" class="md-nav__link">
    <span class="md-ellipsis">
      绘制 &amp; 合成 （Chromium）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="绘制 &amp; 合成 （Chromium）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      绘制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      合成
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#firefox" class="md-nav__link">
    <span class="md-ellipsis">
      绘制 &amp; 合成 （FireFox）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="绘制 &amp; 合成 （FireFox）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      图层的弊端
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      渲染
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      区别总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      参考
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%B7%B1%E5%85%A5%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%95%E6%93%8E%20IV%EF%BC%9AV8%20%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    深入浏览器引擎 IV：V8 垃圾回收机制
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    深入JavaScript篇
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            深入JavaScript篇
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%B7%B1%E5%85%A5JavaScript%E7%AF%87/%E6%B7%B1%E5%85%A5JavaScript%20I%EF%BC%9A%E4%BB%8E%E8%A7%84%E8%8C%83%E4%B8%AD%E7%9C%8BJavaScript%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9C%BA%E5%88%B6/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    深入JavaScript I：从规范中看JavaScript运行时机制
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      渲染管线
    </span>
  </a>
  
    <nav class="md-nav" aria-label="渲染管线">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      解析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      样式计算
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      布局
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chromium" class="md-nav__link">
    <span class="md-ellipsis">
      绘制 &amp; 合成 （Chromium）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="绘制 &amp; 合成 （Chromium）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      绘制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      合成
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#firefox" class="md-nav__link">
    <span class="md-ellipsis">
      绘制 &amp; 合成 （FireFox）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="绘制 &amp; 合成 （FireFox）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      图层的弊端
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      渲染
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      区别总结
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      参考
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="iiichromium-vs-firefox-webrendergpu">深入浏览器引擎 III：Chromium分层合成 vs Firefox WebRender的GPU革命</h1>
<h2 id="_1">渲染管线</h2>
<p>将 HTML 从源代码转化成屏幕像素这一过程称为渲染管线，不同渲染引擎的实现方式有所区别，但是大体上都可以分为五个步骤：</p>
<ol>
<li>解析</li>
<li>样式计算</li>
<li>布局</li>
<li>绘制</li>
<li>合成 &amp; 渲染</li>
</ol>
<p>![[./images/Pasted image 20250714205605.png]]</p>
<h3 id="_2">解析</h3>
<p>HTML 解析器将 HTML 文档源代码转换为 <strong>文档对象模型（DOM）</strong>。DOM 具有两个关键作用：
1. <strong>提供 JavaScript 编程接口：</strong> DOM 作为 JavaScript 操作页面内容、结构和样式的主要接口，通过修改 DOM 可以动态改变页面的最终呈现效果。
2. <strong>作为渲染管线的核心数据结构：</strong> DOM 是浏览器将 HTML 文档转换为屏幕像素的整个渲染管线中的基础数据结构和关键输入。
HTML 解析器的工作原理在前面的[[深入浏览器引擎 II：HTML 解析全流程——从字节流到 DOM 构建]]一章中已经详细介绍过，这里不再赘述。</p>
<p>![[Pasted image 20250712201804.png]]</p>
<h3 id="_3">样式计算</h3>
<p>在样式计算中，CSS 引擎会将 CSS 规则应用到对应的 DOM 节点上，从而生成<strong>渲染树（Render Tree）</strong>。渲染树在 DOM 树的基础上还包含了每个元素节点的 CSS 样式。</p>
<p>CSS 全称层叠样式表，它具有层叠性、继承性和优先级这三大特征。</p>
<ul>
<li>层叠性：样式冲突时，优先级高的样式生效。</li>
<li>继承性：某些样式（如 color、font-size）会自动继承父元素节点。</li>
<li>多个 css 规则作用一个元素时，通过权重来决定哪个规则生效。</li>
</ul>
<p>这些特性共同作用，决定了最终渲染在页面上的样式结果。在样式计算阶段，CSS 引擎计算所有的 CSS 规则，并将匹配的 CSS 规则的样式属性添加到 DOM 树对应的节点中。</p>
<p>![[Pasted image 20250712202236.png]]</p>
<p>具体来说，CSS 引擎会逐个遍历每个 DOM 节点，并找出该 DOM 节点的样式。作为此过程的一部分，它会为 DOM 节点的每个 CSS 属性赋予一个默认值，即使样式表没有为该属性声明值。</p>
<p>对于每个 DOM 节点，CSS 引擎需要遍历所有规则来执行选择器匹配。但是对于大多数节点，这种匹配可能不会经常改变。例如，如果用户将鼠标悬停在父节点上，与其匹配的规则可能会发生变化。由于 CSS 的继承特性，我们仍然需要重新计算其后代的样式来处理属性继承，但与这些后代元素自身所匹配的规则可能不会改变。</p>
<p>因此 CSS 引擎会为 DOM 节点找到所有匹配的规则，并按照优先级排序，形成一个链表结构。多个链表由组成了一颗树状的数据结构，我们称为 CSS 规则树。CSS 规则树只保存了元素自身匹配的结构，不会保存继承的属性。</p>
<p>在这棵 CSS 规则树中，叶子节点就是优先级最高的规则，根据层级的从高到低，规则的优先级也由低到高，DOM 节点将保存叶子节点的指针，在本例中是 <code>div#warning</code>。</p>
<p>![[Pasted image 20250712212433.png]]</p>
<p>当父节点改变时，引擎会快速检查对父级的更改是否会改变与子级匹配的规则。如果没有，那么对于所有后代节点，直接通过保存的叶子节点的指针自下而上得遍历到根节点，就能获得匹配规则的完整列表。</p>
<p>CSS 规则树缓存了每个 DOM 节点匹配的 css 规则列表，当重新样式计算时，可以快速地找到所有匹配规则的完整列表，避免再次遍历所有规则来确认匹配的规则。不过，这只是作为重新样式计算的优化手段，在初次样式计算时，仍然需要遍历所有规则。</p>
<h3 id="_4">布局</h3>
<p>接下来，渲染引擎会计算渲染树，来确定每一个元素的在页面中的位置和宽高等几何属性，这会生成<strong>布局树（Layout Tree）</strong>，布局树上仅包含可见的元素节点，不可见的元素节点（如 <code>display:none</code>）不会保存在布局树中。</p>
<p>![[Pasted image 20250712204048.png]]</p>
<h3 id="chromium">绘制 &amp; 合成 （Chromium）</h3>
<p>不同浏览器内核对于绘制和合成这两步的实现思路和方式差异很大，在这一节，我们以 Chromium 为例。</p>
<h4 id="_5">绘制</h4>
<p>在这一过程中，渲染引擎会将页面划分成多个图层，这类似 PS 的图层概念。一个图层可以看成是一张二维的纸张（x 轴 * y 轴），而多个图层会上下堆叠在一起（z 轴），从而形成了3维空间。</p>
<p>图层没有父子关系，渲染引擎会将图层由后到前地保存在一个平级列表中，Chromium 官方将其称为层树（Layer Tree），因为这曾经是一颗树。</p>
<p>渲染引擎会遍历层树，为每个图层生成绘制指令列表，并将多个图层的绘制指令列表的集合交给合成线程处理。</p>
<blockquote>
<p>注意：绘制实际上是生成绘制指令，最终需要经过合成线程和 GPU 进程的共同操作来转化为像素并渲染到屏幕上。</p>
</blockquote>
<p>![[Pasted image 20250712210757.png]]</p>
<h4 id="_6">合成</h4>
<p>在 Chromium 中，上面四个步骤通常是在主线程中完成的，而最后一步合成操作，渲染引擎通常会交由合成线程来完成，以尽量减少主线程的工作。合成线程会通过与 GPU 进程的共同协作来实现将绘制指令转换成像素渲染到屏幕上。</p>
<p>合成线程会将图层进一步划分更小的图块，然后交由 GPU 进程中的专门进行光栅化（rasterization）的工作线程池<strong>进行</strong>光栅化，从而输出为位图。在 Chromium 中，这是由 Skia 图像库实现的，而 Firefox 中，这由 WebRender 直接调用 GPU 实现。</p>
<p>在这一过程中，离视口越近的图块光栅化的优先级越高，视口内的图块光栅化优先级最高，以便在滚动时能够生成流畅的滚动动画效果。</p>
<blockquote>
<p>光栅化是指将图形或绘制指令转换为像素级的图像数据（位图），也就是把“该画什么”变成“在屏幕的哪些像素上画什么颜色”。在浏览器中，它是将图层内容转为可以上传给 GPU 显示的图像块的过程。</p>
</blockquote>
<p>GPU 进程完成光栅化后，将生成好的位图交还给合成线程，然后合成线程将其合成为帧
，然后交给 GPU 进程中的 Viz 线程，Viz 线程会同步这些帧并处理依赖关系，按照顺序通过 Skia 图像库将这些帧渲染到屏幕上，形成动画帧。</p>
<p>![[Pasted image 20250712211133.png]]</p>
<h3 id="firefox">绘制 &amp; 合成 （FireFox）</h3>
<p>Firefox 在绘制和合成这两步操作和 Chromium 有着显著的差异。</p>
<h4 id="_7">图层的弊端</h4>
<p>在前面，我们讲到绘制过程中会划分图层，生成层树，按照图层来生成绘制指令。划分图层的优势总结起来有两点：</p>
<ol>
<li>一个图层发生变化后，只需要重新布局、绘制和合成该图层，不会影响到其他图层。</li>
<li>划分图层后，可以将多个图层并行地进行光栅化，提高效率。</li>
</ol>
<p>但在 Firefox 开发团队看来，使用层级也有弊端。它们会占用大量内存，实际上还会降低运行速度。浏览器需要在合理的地方合并层级，但很难判断在哪里合理。</p>
<p>常用的 <code>will-change</code> 和 <code>transform</code> 等属性能够提升图层，但是也可能会导致滥用。如果图层过多，这些图层会填满内存，并且传输到合成器需要很长时间。</p>
<p>![[Pasted image 20250714222955.png]]</p>
<p>如果图层过大且没有被合理的拆分，那么这个图层会被不断重绘并传输到合成器，合成器会在不做任何改变的情况下进行合成。这意味着你需要绘制的量加倍了，每个像素都要修改两次，却没有任何效果。如果直接渲染页面，省去合成步骤，速度会更快。</p>
<p>![[Pasted image 20250714223149.png]]</p>
<p>很多情况下，图层的作用并不大。例如，如果你为背景颜色添加动画效果，整个图层无论如何都必须重新绘制。这些图层只能对少量的 CSS 属性有所帮助。</p>
<p>即使大多数帧都处于最佳情况（即它们只占用帧预算的一小部分），仍然可能会出现运动不流畅的情况。对于可察觉的卡顿，只需几帧处于最差情况即可。这些场景被称为性能悬崖。你的应用看似运行良好，直到遇到这些最坏的情况（例如背景颜色动画），你的应用帧率突然跌落到临界点。</p>
<p>![[Pasted image 20250714223316.png]]</p>
<h4 id="_8">渲染</h4>
<p>基于以上问题，firefox 自研了 Webrender 引擎，相对于 Chromium 的绘制和合成步骤有一些显著的改变：</p>
<ol>
<li>不再有图层，而是采用统一的 3D 坐标系的概念，布局现在提供的是<strong>显示列表（display list）</strong> 而不是布局树。</li>
<li>绘制和合成之间不再有区别，它们被合并在<strong>渲染</strong>这一个步骤中。</li>
<li>GPU 将承担更多任务</li>
</ol>
<p>![[Pasted image 20250716220619.png]]</p>
<p>现在，没有图层，只有一个统一的 3D 坐标系，一切元素都通过 x、y、z 坐标来确定位置，这些元素都位置信息保存在显示列表中，由点成线，由线成面。</p>
<p>![[Pasted image 20250716220447.png]]</p>
<p>显示列表是一组高级绘图指令。它告诉我们需要绘制什么，而无需特定于任何图形 API。但是 GPU 无法直接使用这部分代码，而是通过基于 WebRender 在 CPU 上创建的 RenderBackend 线程来将指令转换成 GPU 调用，再通过合成线程按批次中转传递给 GPU 后，才能被调用。</p>
<p>![[Pasted image 20250716221914.png]]</p>
<p>通过 WebRender 引擎，CPU将不再需要频繁地进行绘制、图层计算和合成等操作：</p>
<ol>
<li>主线程不再需要完成全部的绘制任务，大部分的绘制将由 GPU 承担。（部分绘制任务仍然只能考 CPU 完成）</li>
<li>合成线程不再需要频繁地划分图块和合成，现在只需要同步帧率和批量转发 RenderBackend 线程传递的 CPU 调用即可。</li>
<li>GPU 现在承担大部分的绘制、光栅化等工作，CPU 得到释放。</li>
</ol>
<p>随着硬件的发展，GPU 的能力越来越强大，通过将更多的任务交给GPU，可以让 CPU 更专注处理 JavaScript 执行和垃圾回收等工作，这对性能有非常积极的影响。</p>
<h3 id="_9">区别总结</h3>
<table>
<thead>
<tr>
<th></th>
<th>Chromium</th>
<th>Firefox</th>
</tr>
</thead>
<tbody>
<tr>
<td>浏览器内核</td>
<td>Chromium</td>
<td>Gecko</td>
</tr>
<tr>
<td>渲染引擎</td>
<td>Blink</td>
<td>Gecko</td>
</tr>
<tr>
<td>图形渲染引擎</td>
<td>Skia</td>
<td>WebRender</td>
</tr>
<tr>
<td>布局</td>
<td>输出布局树</td>
<td>输出显示列表</td>
</tr>
<tr>
<td>绘制</td>
<td>由CPU 完成</td>
<td>由GPU + CPU 共同完成</td>
</tr>
<tr>
<td>合成</td>
<td>负责划分图块、合成等</td>
<td>只负责同步帧率和转发</td>
</tr>
<tr>
<td>CPU线程</td>
<td>主线程+合成线程</td>
<td>主线程+RenderBackend 线程+合成线程</td>
</tr>
<tr>
<td>优化策略</td>
<td>划分图层，图层间的回流重绘互不影响</td>
<td>采用3D 坐标系，将更多任务交给 GPU</td>
</tr>
<tr>
<td>性能特点</td>
<td>在复杂 DOM 场景下可能更快（分块渲染）。但是大量动画场景下可能出现性能悬崖。</td>
<td>在 GPU 加速场景（如大量动画）中更稳定。</td>
</tr>
</tbody>
</table>
<h2 id="_10">参考</h2>
<p><a href="https://www.youtube.com/watch?v=K2QHdgAKP-s&amp;t=1226s">Life of a Pixel</a>
https://developer.chrome.com/blog/inside-browser-part1?hl=zh-cn
[The whole web at maximum FPS: How WebRender gets rid of jank)</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>